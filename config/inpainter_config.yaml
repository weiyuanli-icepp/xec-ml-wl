# ===================================================
# Inpainter (Dead Channel Recovery) Configuration
# ===================================================

# === Data Configuration ===
data:
  train_path: "~/meghome/xec-ml-wl/data/E52.8_AngUni_PosSQ/large_train.root"
  val_path: "~/meghome/xec-ml-wl/data/E52.8_AngUni_PosSQ/large_val.root"
  tree_name: "tree"
  batch_size: 1024
  chunksize: 256000
  num_workers: 1
  num_threads: 4
  npho_branch: "npho"        # Input branch for photon counts (or "npho")
  time_branch: "relative_time"        # Input branch for timing (or "time")

# === Input Normalization ===
# Must match MAE pretraining normalization
normalization:
  npho_scale: 1000
  npho_scale2: 4.08
  time_scale: 1.14e-7
  time_shift: -0.46
  sentinel_value: -1.0

# === Model Configuration ===
model:
  outer_mode: "finegrid"            # Must match MAE encoder config
  outer_fine_pool: [3, 3]           # Must match MAE encoder config
  mask_ratio: 0.05                  # Realistic dead channel density (1-10%)
  time_mask_ratio_scale: 1.0        # Scale factor for masking valid-time sensors (>1.0 to prefer masking valid-time)
  freeze_encoder: false              # Freeze encoder, train only inpainting heads

# === Training Configuration ===
training:
  # mae_checkpoint: "artifacts/mae/mae_checkpoint_best.pth"  # Path to pretrained MAE
  mae_checkpoint: null              # null = no pretrained MAE
  epochs: 50
  lr: 1.0e-4
  lr_scheduler: "cosine"            # "cosine" or null
  lr_min: 1.0e-6
  warmup_epochs: 3
  weight_decay: 1.0e-4
  loss_fn: "smooth_l1"              # Options: smooth_l1, mse, l1, huber
  npho_weight: 1.0                  # Weight for npho channel loss
  time_weight: 1.0                  # Weight for time channel loss
  grad_clip: 1.0                    # Gradient clipping (0 to disable)
  amp: true                         # Automatic Mixed Precision
  track_mae_rmse: false              # Compute/log MAE/RMSE metrics (set false to skip)
  grad_accum_steps: 4               # Gradient accumulation steps (effective batch = batch_size * grad_accum_steps)
  track_train_metrics: false         # Track per-face metrics during training (set false to log only total_loss)
  npho_threshold: 100              # Npho threshold for conditional time loss (null uses default 10.0)
  use_npho_time_weight: true        # Weight time loss by sqrt(npho) for chi-square-like weighting

# === Checkpointing ===
checkpoint:
  resume_from: null                 # Path to inpainter checkpoint to resume from
  save_dir: "artifacts/inpainter"   # Directory to save checkpoints
  save_interval: 10                 # Save checkpoint every N epochs
  save_predictions: true            # Write ROOT outputs during validation

# === MLflow ===
mlflow:
  experiment: "inpainting"
  run_name: null                    # null = auto-generate timestamp
