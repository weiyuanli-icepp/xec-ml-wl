# ===================================================
# MAE (Masked Autoencoder) Pre-training Configuration
# ===================================================

# === Data Configuration ===
data:
  train_path: "~/meghome/xec-ml-wl/data/E52.8_AngUni_PosSQ/large_train.root"
  val_path: "~/meghome/xec-ml-wl/data/E52.8_AngUni_PosSQ/large_val.root"
  tree_name: "tree"
  batch_size: 1024                  # Reduced from 8192 (MAE decoder needs more memory)
  chunksize: 256000
  num_workers: 1                    # Reduced for GH nodes (system suggested max=1)
  num_threads: 4                    # CPU preprocessing threads
  npho_branch: "npho"      # Input branch for photon counts (or "npho")
  time_branch: "relative_time"      # Input branch for timing (or "time")
  log_invalid_npho: true            # Log warning when invalid npho values are detected

# === Input Normalization ===
# Same as regressor training to ensure consistency
normalization:
  npho_scale: 1000
  npho_scale2: 4.08
  time_scale: 1.14e-7
  time_shift: -0.46
  sentinel_time: -1.0
  sentinel_npho: -1.0           # Sentinel for dead/masked npho channel
  # Normalization scheme for npho:
  #   "log1p" (default) - log1p(x/scale)/scale2, good for wide dynamic range
  #   "anscombe" - 2*sqrt(x + 3/8), variance stabilization for Poisson data
  #   "sqrt" - sqrt(x)/sqrt(scale), simpler variance stabilization
  #   "linear" - x/scale, no transform (baseline)
  npho_scheme: "log1p"

# === Model Configuration ===
model:
  outer_mode: "finegrid"            # "finegrid" or "split"
  outer_fine_pool: null             # null or [h, w] for pooling
  mask_ratio: 0.65                  # Fraction of input to mask (0.5-0.75 typical)
  # DEPRECATED: delete this line. Use training.time.mask_ratio_scale instead.
  time_mask_ratio_scale: 1.0        # Scale factor for masking valid-time sensors (>1.0 to prefer masking valid-time)
  predict_channels: ["npho", "time"]  # Output channels to predict: ["npho"] or ["npho", "time"]
                                      # Use ["npho"] for faster training when time prediction is not needed
  decoder_dim: 128                  # Lightweight decoder dimension (MAE paper: decoder << encoder)
                                      # Default 128, smaller values force encoder to learn more

# === Training Configuration ===
training:
  epochs: 20
  lr: 2.5e-4
  lr_scheduler: null           # "cosine" or null
  lr_min: 1.0e-8
  warmup_epochs: 3
  weight_decay: 5.0e-5
  loss_fn: "smooth_l1"            # Options: smooth_l1, mse, l1, huber
  npho_weight: 1.0                # Per-channel manual weighting
  # DEPRECATED: delete this line. Use training.time.weight instead.
  time_weight: 1.0                # Set <1.0 to downweight time channel
  auto_channel_weight: false      # Learn log(sigma^2) per channel (overrides manual weights)
  grad_clip: 1.0                    # Gradient clipping (0 to disable)
  grad_accum_steps: 1               # Gradient accumulation steps (effective batch = batch_size * grad_accum_steps)
  ema_decay: null                   # EMA decay rate (null to disable, 0.999 typical)
  amp: true                         # Automatic Mixed Precision
  # torch.compile mode options:
  #   "max-autotune" - Maximum optimization, benchmarks many kernel configs (highest memory)
  #   "reduce-overhead" - Lower compilation overhead and memory, good balance
  #   "default" - Basic compilation with minimal overhead
  #   "false" or "none" - Disable compilation, use eager mode (no extra memory)
  compile: "reduce-overhead"
  # DEPRECATED: delete this line. Use training.time.npho_threshold instead.
  npho_threshold: 100              # Npho threshold for conditional time loss (null uses default 10.0)
  # DEPRECATED: delete this line. Use training.time.use_npho_weight instead.
  use_npho_time_weight: true        # Weight time loss by sqrt(npho) for chi-square-like weighting
  track_mae_rmse: false             # Compute/log MAE/RMSE metrics (slower, set true for detailed analysis)
  track_train_metrics: false        # Track per-face loss during training (slower, set true for debugging)
  profile: false                    # Enable training profiler to identify bottlenecks

  # === Npho Loss Weighting ===
  # Weight reconstruction loss by (npho + 1)^alpha to give higher weight to high-photon-count sensors
  npho_loss_weight:
    enabled: false                  # Enable intensity-based loss weighting
    alpha: 0.5                      # Exponent: 0.5 = sqrt, 1.0 = linear

  # === Intensity-based Sample Reweighting ===
  # Reweight samples by total event intensity to balance representation
  intensity_reweighting:
    enabled: false                  # Enable intensity-based sample reweighting
    nbins: 5                        # Number of intensity bins
    target: "uniform"               # Target distribution ("uniform")

# === Checkpointing ===
checkpoint:
  resume_from: null                 # Path to checkpoint to resume from
  save_dir: "artifacts"             # Directory to save checkpoints
  save_interval: 10                 # Save checkpoint every N epochs
  save_predictions: false           # Save sensor-level predictions to ROOT file
  root_save_interval: 10            # Save ROOT predictions every N epochs
  new_mlflow_run: false             # Create new MLflow run when resuming (vs continue existing)

# === Distributed Training ===
distributed:
  num_gpus: 1                       # Number of GPUs (1 = single-GPU, >1 = DDP multi-GPU)

# === MLflow ===
mlflow:
  experiment: "mae_pretraining"
  run_name: null                    # null = auto-generate timestamp
